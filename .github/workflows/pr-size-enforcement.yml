name: PR Size Enforcement - Check

on:
  pull_request:
    types: [labeled, unlabeled, opened, edited, synchronize]

permissions:
  contents: read

jobs:
  check-xl-justification:
    name: Check XL PR Justification
    runs-on: ubuntu-latest
    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const labels = pr.data.labels.map(l => l.name);
            const hasXLLabel = labels.includes('size/XL');
            const prBody = pr.data.body || '';
            const hasJustification = /##\s*Large PR Justification/i.test(prBody);

            console.log('PR Number:', context.issue.number);
            console.log('Has XL label:', hasXLLabel);
            console.log('Has justification:', hasJustification);

            return {
              prNumber: context.issue.number,
              hasXLLabel: hasXLLabel,
              hasJustification: hasJustification,
              needsEnforcement: hasXLLabel && !hasJustification,
              shouldDismiss: hasXLLabel && hasJustification
            };

      - name: Save enforcement result to artifact
        run: |
          mkdir -p pr-enforcement
          echo '${{ steps.pr.outputs.result }}' > pr-enforcement/result.json
          cat pr-enforcement/result.json

      - name: Upload artifact
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808 # v4
        with:
          name: pr-enforcement-result
          path: pr-enforcement/
          retention-days: 1