# SPDX-FileCopyrightText: Copyright 2025 Stacklok, Inc.
# SPDX-License-Identifier: Apache-2.0

# PR Gate - Sentinel workflow that ensures all quality checks pass
#
# This workflow acts as a single entry point for branch protection rules.
# It waits for all triggered quality checks to complete and reports their
# combined status. This solves the problem of conditional workflows:
# - Some workflows only run when certain files are touched
# - Branch protection can't require workflows that don't always run
# - This gate checks all jobs that DID run and reports success/failure
#
# Configure branch protection to require only the "All Checks Pass" job.

name: PR Gate

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Detect which files changed to determine which checks to run
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      charts: ${{ steps.filter.outputs.charts }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            code:
              - '!deploy/charts/**'
            charts:
              - 'deploy/charts/**'

  # ============================================================================
  # PR Checks (Go code) - from run-on-pr.yml
  # These run when NOT touching deploy/charts/**
  # ============================================================================

  pr-spellcheck:
    name: Spellcheck
    needs: changes
    if: needs.changes.outputs.code == 'true'
    uses: ./.github/workflows/spellcheck.yml

  pr-license-headers:
    name: License Headers
    needs: changes
    if: needs.changes.outputs.code == 'true'
    uses: ./.github/workflows/license-headers.yml

  pr-linting:
    name: Linting
    needs: changes
    if: needs.changes.outputs.code == 'true'
    uses: ./.github/workflows/lint.yml

  pr-security-scan:
    name: Security Scan
    needs: changes
    if: needs.changes.outputs.code == 'true'
    permissions:
      contents: read
      security-events: write
    uses: ./.github/workflows/security-scan.yml

  pr-tests:
    name: Tests
    needs: changes
    if: needs.changes.outputs.code == 'true'
    uses: ./.github/workflows/test.yml
    secrets: inherit

  pr-docs:
    name: Docs
    needs: changes
    if: needs.changes.outputs.code == 'true'
    uses: ./.github/workflows/verify-docgen.yml

  pr-codegen:
    name: Codegen
    needs: changes
    if: needs.changes.outputs.code == 'true'
    uses: ./.github/workflows/verify-gen.yml

  pr-e2e-tests:
    name: E2E Tests
    needs: [changes, pr-linting, pr-tests, pr-docs, pr-codegen]
    if: |
      !cancelled() &&
      needs.changes.outputs.code == 'true'
    uses: ./.github/workflows/e2e-tests.yml

  pr-operator-ci:
    name: Operator CI
    needs: [changes, pr-linting, pr-tests, pr-docs, pr-codegen]
    if: |
      !cancelled() &&
      needs.changes.outputs.code == 'true'
    permissions:
      contents: read
    uses: ./.github/workflows/operator-ci.yml

  # ============================================================================
  # Chart Checks - from run-on-pr-charts.yml
  # These run when ONLY touching deploy/charts/**
  # ============================================================================

  charts-spellcheck:
    name: Charts Spellcheck
    needs: changes
    if: needs.changes.outputs.charts == 'true'
    uses: ./.github/workflows/spellcheck.yml

  charts-linting:
    name: Charts Linting
    needs: changes
    if: needs.changes.outputs.charts == 'true'
    uses: ./.github/workflows/lint-helm-charts.yml

  charts-tests:
    name: Charts Tests
    needs: changes
    if: needs.changes.outputs.charts == 'true'
    uses: ./.github/workflows/test-helm-charts.yml

  # ============================================================================
  # SENTINEL JOB - This is the job to require in branch protection
  # ============================================================================

  all-checks:
    name: All Checks Pass
    runs-on: ubuntu-latest
    # CRITICAL: Always run this job, even if some dependencies were skipped
    if: always()

    steps:
      - name: Wait for all checks to complete
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;
            if (!prNumber) {
              core.setFailed('No PR number found');
              return;
            }

            const sha = context.payload.pull_request.head.sha;

            console.log(`Checking status of all workflow runs for PR #${prNumber} (SHA: ${sha})`);
            console.log('');

            // Wait for all workflows to complete (max 60 minutes)
            const maxWaitTime = 60 * 60 * 1000; // 60 minutes
            const pollInterval = 10 * 1000; // 10 seconds
            const startTime = Date.now();

            while (Date.now() - startTime < maxWaitTime) {
              // Get all workflow runs for this commit
              const { data: workflowRuns } = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head_sha: sha,
                per_page: 100
              });

              // Filter to runs from this PR (exclude the pr-gate workflow itself)
              const prWorkflows = workflowRuns.workflow_runs.filter(run =>
                run.name !== 'PR Gate' &&
                run.event === 'pull_request'
              );

              console.log(`Found ${prWorkflows.length} workflow runs for this PR`);

              // Check if all are complete
              const pending = prWorkflows.filter(run =>
                run.status === 'queued' || run.status === 'in_progress'
              );

              if (pending.length === 0) {
                console.log('All workflows completed');
                console.log('');

                // Print status of all workflows
                console.log('Workflow Status Summary:');
                console.log('========================');
                prWorkflows.forEach(run => {
                  const status = run.conclusion || run.status;
                  const icon = status === 'success' ? 'âœ…' :
                               status === 'skipped' ? 'â­ï¸' :
                               status === 'cancelled' ? 'ðŸš«' :
                               'âŒ';
                  console.log(`${icon} ${run.name}: ${status}`);
                });
                console.log('');

                // Check for failures or cancellations
                const failed = prWorkflows.filter(run =>
                  run.conclusion === 'failure' || run.conclusion === 'cancelled'
                );

                if (failed.length > 0) {
                  console.log('âŒ The following workflows failed or were cancelled:');
                  failed.forEach(run => {
                    console.log(`   - ${run.name}: ${run.conclusion}`);
                  });
                  core.setFailed('One or more quality checks failed');
                  return;
                }

                console.log('âœ… All quality checks passed or were skipped appropriately');
                return;
              }

              console.log(`Waiting for ${pending.length} workflows to complete...`);
              pending.forEach(run => {
                console.log(`  - ${run.name}: ${run.status}`);
              });
              console.log('');

              // Wait before next poll
              await new Promise(resolve => setTimeout(resolve, pollInterval));
            }

            core.setFailed('Timeout waiting for all workflows to complete');
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
