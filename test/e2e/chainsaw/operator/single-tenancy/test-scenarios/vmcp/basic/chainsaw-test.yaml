apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: vmcp-crd
spec:
  description: Test VirtualMCPServer CRD creation
  steps:
  - name: create-mcpgroup
    try:
    - apply:
        resource:
          apiVersion: toolhive.stacklok.dev/v1alpha1
          kind: MCPGroup
          metadata:
            name: test-group
          spec:
            description: "Test group for VirtualMCPServer"

  - name: create-virtualmcpserver
    try:
    - apply:
        resource:
          apiVersion: toolhive.stacklok.dev/v1alpha1
          kind: VirtualMCPServer
          metadata:
            name: test-vmcp
          spec:
            config:
              groupRef: test-group
              aggregation:
                conflictResolution: prefix
            incomingAuth:
              type: oidc
              oidcConfig:
                type: inline
                inline:
                  issuer: https://auth.example.com
                  audience: virtual-mcp
            outgoingAuth:
              source: discovered
    - assert:
        resource:
          apiVersion: toolhive.stacklok.dev/v1alpha1
          kind: VirtualMCPServer
          metadata:
            name: test-vmcp
