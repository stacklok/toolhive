name: PR Size Enforcement

on:
  pull_request:
    types: [labeled, unlabeled, opened, edited, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  enforce-xl-justification:
    name: Enforce XL PR Justification
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository && contains(github.event.pull_request.labels.*.name, 'size/XL')
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Check for justification
        id: check
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';

            // Look for the justification section header
            const hasJustification = /##\s*Large PR Justification/i.test(prBody);

            console.log('PR Body length:', prBody.length);
            console.log('Has justification section:', hasJustification);

            return hasJustification;

      - name: Request changes if no justification
        if: steps.check.outputs.result == 'false'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            // Check if we already have a review requesting changes
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const botReview = reviews.data.find(review =>
              review.user.login === 'github-actions[bot]' &&
              review.state === 'CHANGES_REQUESTED'
            );

            if (botReview) {
              console.log('Already requested changes in review:', botReview.id);
              return;
            }

            // Read the message template from file
            const fs = require('fs');
            const template = fs.readFileSync('.github/workflows/pr-size-justification-template.md', 'utf8');
            const contributingLink = `https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md#code-quality-expectations`;
            const message = template.replace('CONTRIBUTING_LINK', contributingLink);

            // Request changes with explanation
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              event: 'REQUEST_CHANGES',
              body: message
            });

            console.log('Created review requesting changes');

      - name: Dismiss review if justification added
        if: steps.check.outputs.result == 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            // Find our previous review requesting changes
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const botReview = reviews.data.find(review =>
              review.user.login === 'github-actions[bot]' &&
              review.state === 'CHANGES_REQUESTED'
            );

            if (botReview) {
              await github.rest.pulls.dismissReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                review_id: botReview.id,
                message: 'Large PR justification has been provided. Thank you!'
              });

              console.log('Dismissed previous review:', botReview.id);

              // Add a comment confirming unblock
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: 'âœ… Large PR justification has been provided. The size review has been dismissed and this PR can now proceed with normal review.'
              });
            } else {
              console.log('No previous blocking review found');
            }
