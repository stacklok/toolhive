name: E2E Tests

on:
  workflow_call:

permissions:
  contents: read

jobs:
  build-binary:
    name: Build ToolHive Binary
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Install Task
        uses: arduino/setup-task@b91d5d2c96a56797b48ac1e0e89220bf64044611 # v2
        with:
          version: 3.44.1
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build ToolHive binary
        run: |
          task build
          # Verify the binary was created and is executable
          ls -la ./bin/
          chmod +x ./bin/thv

      - name: Upload ToolHive binary
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: toolhive-binary
          path: ./bin/thv
          retention-days: 1

  e2e-tests-core:
    name: E2E Tests Core (${{ matrix.title }})
    runs-on: ubuntu-latest
    needs: build-binary
    strategy:
      fail-fast: false
      matrix:
        include:
          - title: core
            label_filter: core
            artifact: e2e-test-results-core
          - title: mcp
            label_filter: mcp
            artifact: e2e-test-results-mcp
          - title: proxy-mw
            label_filter: 'proxy || middleware || stability'
            artifact: e2e-test-results-proxy-mw
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Install dependencies
        run: |
          go mod download
      - name: Install Ginkgo CLI
        run: |
          go install github.com/onsi/ginkgo/v2/ginkgo@latest

      - name: Download ToolHive binary
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: toolhive-binary
          path: ./bin/

      - name: Set binary permissions
        run: |
          chmod +x ./bin/thv
          ls -la ./bin/

      - name: Set up container runtime (Docker)
        run: |
          # Docker is already installed on ubuntu-latest
          docker --version
          # Start Docker daemon if not running
          sudo systemctl start docker

      - name: Run E2E tests (${{ matrix.title }})
        env:
          THV_BINARY: ${{ github.workspace }}/bin/thv
          TOOLHIVE_EGRESS_IMAGE: ghcr.io/stacklok/toolhive/egress-proxy:latest
          TEST_TIMEOUT: 15m
          LABEL_FILTER: ${{ matrix.label_filter }}
        run: ./test/e2e/run_tests.sh

      - name: Upload test results (${{ matrix.title }})
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: ${{ matrix.artifact }}
          path: |
            test/e2e/ginkgo-report.xml
            test/e2e/junit-report.xml
          retention-days: 7

  e2e-tests-api:
    name: E2E Tests API (${{ matrix.title }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - title: api
            label_filter: api
            artifact: e2e-test-results-api
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Install dependencies
        run: |
          go mod download
      - name: Install Ginkgo CLI
        run: |
          go install github.com/onsi/ginkgo/v2/ginkgo@latest

      - name: Set up container runtime (Docker)
        run: |
          # Docker is already installed on ubuntu-latest
          docker --version
          # Start Docker daemon if not running
          sudo systemctl start docker

      - name: Run API E2E tests (${{ matrix.title }})
        env:
          TEST_TIMEOUT: 10m
          LABEL_FILTER: ${{ matrix.label_filter }}
        run: ./test/e2e/api/run_tests.sh

      - name: Upload test results (${{ matrix.title }})
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: ${{ matrix.artifact }}
          path: |
            test/e2e/api/ginkgo-report.xml
            test/e2e/api/junit-report.xml
          retention-days: 7
