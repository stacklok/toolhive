# SPDX-FileCopyrightText: Copyright 2025 Stacklok, Inc.
# SPDX-License-Identifier: Apache-2.0

# PR Gate - Dynamic sentinel workflow that ensures all quality checks pass
#
# This workflow acts as a single entry point for branch protection rules.
# It dynamically discovers and waits for all quality checks to complete,
# then reports their combined status.
#
# How it works:
# - Individual quality check workflows run independently on pull_request events
# - Each workflow has path filtering to skip when files aren't relevant
# - This sentinel discovers all workflows that ran via the GitHub API
# - Reports success if all workflows pass (or skip appropriately)
#
# Adding new checks: Just create a workflow with 'on: pull_request'
# No need to update this file - the sentinel discovers workflows automatically
#
# Configure branch protection to require only the "All Checks Pass" job.

name: PR Gate

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # ============================================================================
  # SENTINEL JOB - This is the only job to require in branch protection
  # ============================================================================
  # This job dynamically discovers all workflows that ran on this PR and
  # validates that they all passed (or skipped appropriately).
  #
  # Individual workflows run independently with path filtering at the job level.

  all-checks:
    name: All Checks Pass
    runs-on: ubuntu-latest
    # CRITICAL: Always run this job, even if some dependencies were skipped
    if: always()

    steps:
      - name: Wait for all checks to complete
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;
            if (!prNumber) {
              core.setFailed('No PR number found');
              return;
            }

            const sha = context.payload.pull_request.head.sha;

            console.log(`Checking status of all workflow runs for PR #${prNumber} (SHA: ${sha})`);
            console.log('');

            // Wait for all workflows to complete (max 60 minutes)
            const maxWaitTime = 60 * 60 * 1000; // 60 minutes
            const pollInterval = 10 * 1000; // 10 seconds
            const startTime = Date.now();

            while (Date.now() - startTime < maxWaitTime) {
              // Get all workflow runs for this commit
              const { data: workflowRuns } = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head_sha: sha,
                per_page: 100
              });

              // Filter to runs from this PR (exclude the pr-gate workflow itself)
              const prWorkflows = workflowRuns.workflow_runs.filter(run =>
                run.name !== 'PR Gate' &&
                run.event === 'pull_request'
              );

              console.log(`Found ${prWorkflows.length} workflow runs for this PR`);

              // Check if all are complete
              const pending = prWorkflows.filter(run =>
                run.status === 'queued' || run.status === 'in_progress'
              );

              if (pending.length === 0) {
                console.log('All workflows completed');
                console.log('');

                // Print status of all workflows
                console.log('Workflow Status Summary:');
                console.log('========================');
                prWorkflows.forEach(run => {
                  const status = run.conclusion || run.status;
                  const icon = status === 'success' ? 'âœ…' :
                               status === 'skipped' ? 'â­ï¸' :
                               status === 'cancelled' ? 'ðŸš«' :
                               'âŒ';
                  console.log(`${icon} ${run.name}: ${status}`);
                });
                console.log('');

                // Check for failures or cancellations
                const failed = prWorkflows.filter(run =>
                  run.conclusion === 'failure' || run.conclusion === 'cancelled'
                );

                if (failed.length > 0) {
                  console.log('âŒ The following workflows failed or were cancelled:');
                  failed.forEach(run => {
                    console.log(`   - ${run.name}: ${run.conclusion}`);
                  });
                  core.setFailed('One or more quality checks failed');
                  return;
                }

                console.log('âœ… All quality checks passed or were skipped appropriately');
                return;
              }

              console.log(`Waiting for ${pending.length} workflows to complete...`);
              pending.forEach(run => {
                console.log(`  - ${run.name}: ${run.status}`);
              });
              console.log('');

              // Wait before next poll
              await new Promise(resolve => setTimeout(resolve, pollInterval));
            }

            core.setFailed('Timeout waiting for all workflows to complete');
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
