name: Trigger Docs Update

permissions: {}

on:
  workflow_call:
    inputs:
      version:
        description: 'Version tag for the release'
        required: true
        type: string
      assign_to:
        description: 'GitHub username to assign the PR to'
        required: false
        type: string
    secrets:
      DOCS_REPO_DISPATCH_TOKEN:
        required: true

jobs:
  trigger-docs-update:
    name: Trigger Documentation Update
    runs-on: ubuntu-slim

    steps:
      - name: Trigger docs update workflow
        run: |
          repo="stacklok/docs-website"
          event_type="published-release"
          version="${{ inputs.version }}"
          assign_to="${{ inputs.assign_to }}"

          echo "Triggering docs update for $repo with version $version"
          if [ -n "$assign_to" ]; then
            echo "Will assign PR to: $assign_to"
          fi

          # Build client_payload JSON
          payload="{\"version\": \"$version\""
          if [ -n "$assign_to" ]; then
            payload="$payload, \"assign_to\": \"$assign_to\""
          fi
          payload="$payload}"

          curl --fail -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.DOCS_REPO_DISPATCH_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/$repo/dispatches \
            -d "{\"event_type\": \"$event_type\", \"client_payload\": $payload}"
