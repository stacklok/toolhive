---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.17.3
  name: mcpexternalauthconfigs.toolhive.stacklok.dev
spec:
  group: toolhive.stacklok.dev
  names:
    kind: MCPExternalAuthConfig
    listKind: MCPExternalAuthConfigList
    plural: mcpexternalauthconfigs
    shortNames:
    - extauth
    - mcpextauth
    singular: mcpexternalauthconfig
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.type
      name: Type
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          MCPExternalAuthConfig is the Schema for the mcpexternalauthconfigs API.
          MCPExternalAuthConfig resources are namespace-scoped and can only be referenced by
          MCPServer resources within the same namespace. Cross-namespace references
          are not supported for security and isolation reasons.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: |-
              MCPExternalAuthConfigSpec defines the desired state of MCPExternalAuthConfig.
              MCPExternalAuthConfig resources are namespace-scoped and can only be referenced by
              MCPServer resources in the same namespace.
            properties:
              headerInjection:
                description: |-
                  HeaderInjection configures custom HTTP header injection
                  Only used when Type is "headerInjection"
                properties:
                  headerName:
                    description: HeaderName is the name of the HTTP header to inject
                    minLength: 1
                    type: string
                  valueSecretRef:
                    description: ValueSecretRef references a Kubernetes Secret containing
                      the header value
                    properties:
                      key:
                        description: Key is the key within the secret
                        type: string
                      name:
                        description: Name is the name of the secret
                        type: string
                    required:
                    - key
                    - name
                    type: object
                required:
                - headerName
                - valueSecretRef
                type: object
              oauth:
                description: |-
                  OAuth configures OAuth flow with an upstream Identity Provider
                  Only used when Type is "oauth"
                properties:
                  authServer:
                    description: |-
                      AuthServer configures the embedded OAuth authorization server
                      that clients authenticate to (the proxy's own auth endpoints).
                    properties:
                      accessTokenLifespan:
                        default: 1h
                        description: |-
                          AccessTokenLifespan is the lifetime of access tokens issued by this server.
                          Defaults to "1h" if not specified.
                        pattern: ^[0-9]+(s|m|h)$
                        type: string
                      clients:
                        description: Clients are the OAuth clients allowed to authenticate
                          to this auth server.
                        items:
                          description: OAuthClientConfig defines a pre-registered
                            OAuth client
                          properties:
                            id:
                              description: ID is the client identifier
                              type: string
                            public:
                              default: false
                              description: Public indicates this is a public client
                                (no secret required)
                              type: boolean
                            redirectUris:
                              description: RedirectURIs are the allowed redirect URIs
                                for this client
                              items:
                                type: string
                              type: array
                            secret:
                              description: Secret is the client secret. Empty for
                                public clients.
                              type: string
                          required:
                          - id
                          - redirectUris
                          type: object
                        type: array
                      hmacSecretRef:
                        description: |-
                          HMACSecretRef references a Secret containing the HMAC secret for token signing.
                          The secret must be at least 32 bytes. Required for multi-replica deployments.
                        properties:
                          key:
                            description: Key is the key within the secret
                            type: string
                          name:
                            description: Name is the name of the secret
                            type: string
                        required:
                        - key
                        - name
                        type: object
                      issuer:
                        description: |-
                          Issuer is where clients access the proxy's /.well-known/openid-configuration
                          This should match the external URL where clients reach the MCP server.
                        type: string
                      signingKeyRef:
                        description: |-
                          SigningKeyRef references a Secret containing the RSA private key (PEM)
                          for signing JWTs issued by this auth server.
                        properties:
                          key:
                            description: Key is the key within the secret
                            type: string
                          name:
                            description: Name is the name of the secret
                            type: string
                        required:
                        - key
                        - name
                        type: object
                      storage:
                        description: |-
                          Storage configures the storage backend for OAuth session data.
                          If not specified, defaults to in-memory storage.
                        properties:
                          redis:
                            description: Redis configures Redis storage. Required
                              when Type is "redis".
                            properties:
                              keyPrefix:
                                default: 'thv:authserver:'
                                description: KeyPrefix is the prefix for all Redis
                                  keys.
                                type: string
                              passwordRef:
                                description: PasswordRef references a Secret containing
                                  the Redis password.
                                properties:
                                  key:
                                    description: Key is the key within the secret
                                    type: string
                                  name:
                                    description: Name is the name of the secret
                                    type: string
                                required:
                                - key
                                - name
                                type: object
                              url:
                                description: URL is the Redis connection URL (e.g.,
                                  redis://redis:6379/0).
                                type: string
                            required:
                            - url
                            type: object
                          type:
                            default: memory
                            description: Type specifies the storage backend type.
                            enum:
                            - memory
                            - redis
                            type: string
                        type: object
                    required:
                    - issuer
                    - signingKeyRef
                    type: object
                  upstream:
                    description: |-
                      Upstream configures the external Identity Provider
                      that users authenticate against (e.g., Google, Okta).
                    properties:
                      clientId:
                        description: ClientID is the OAuth client ID registered with
                          the upstream IDP
                        type: string
                      clientSecretRef:
                        description: ClientSecretRef references a Secret containing
                          the upstream client secret
                        properties:
                          key:
                            description: Key is the key within the secret
                            type: string
                          name:
                            description: Name is the name of the secret
                            type: string
                        required:
                        - key
                        - name
                        type: object
                      issuer:
                        description: |-
                          Issuer is the URL of the upstream IDP (e.g., https://accounts.google.com)
                          The proxy will use OIDC discovery to find authorization and token endpoints.
                        type: string
                      scopes:
                        default:
                        - openid
                        - email
                        description: |-
                          Scopes are the OAuth scopes to request from the upstream IDP.
                          Defaults to ["openid", "email"] if not specified.
                        items:
                          type: string
                        type: array
                    required:
                    - clientId
                    - clientSecretRef
                    - issuer
                    type: object
                required:
                - authServer
                - upstream
                type: object
              tokenExchange:
                description: |-
                  TokenExchange configures RFC-8693 OAuth 2.0 Token Exchange
                  Only used when Type is "tokenExchange"
                properties:
                  audience:
                    description: Audience is the target audience for the exchanged
                      token
                    type: string
                  clientId:
                    description: |-
                      ClientID is the OAuth 2.0 client identifier
                      Optional for some token exchange flows (e.g., Google Cloud Workforce Identity)
                    type: string
                  clientSecretRef:
                    description: |-
                      ClientSecretRef is a reference to a secret containing the OAuth 2.0 client secret
                      Optional for some token exchange flows (e.g., Google Cloud Workforce Identity)
                    properties:
                      key:
                        description: Key is the key within the secret
                        type: string
                      name:
                        description: Name is the name of the secret
                        type: string
                    required:
                    - key
                    - name
                    type: object
                  externalTokenHeaderName:
                    description: |-
                      ExternalTokenHeaderName is the name of the custom header to use for the exchanged token.
                      If set, the exchanged token will be added to this custom header (e.g., "X-Upstream-Token").
                      If empty or not set, the exchanged token will replace the Authorization header (default behavior).
                    type: string
                  scopes:
                    description: Scopes is a list of OAuth 2.0 scopes to request for
                      the exchanged token
                    items:
                      type: string
                    type: array
                  subjectTokenType:
                    description: |-
                      SubjectTokenType is the type of the incoming subject token.
                      Accepts short forms: "access_token" (default), "id_token", "jwt"
                      Or full URNs: "urn:ietf:params:oauth:token-type:access_token",
                                    "urn:ietf:params:oauth:token-type:id_token",
                                    "urn:ietf:params:oauth:token-type:jwt"
                      For Google Workload Identity Federation with OIDC providers (like Okta), use "id_token"
                    pattern: ^(access_token|id_token|jwt|urn:ietf:params:oauth:token-type:(access_token|id_token|jwt))?$
                    type: string
                  tokenUrl:
                    description: TokenURL is the OAuth 2.0 token endpoint URL for
                      token exchange
                    type: string
                required:
                - audience
                - tokenUrl
                type: object
              type:
                description: Type is the type of external authentication to configure
                enum:
                - tokenExchange
                - headerInjection
                - unauthenticated
                - oauth
                type: string
            required:
            - type
            type: object
          status:
            description: MCPExternalAuthConfigStatus defines the observed state of
              MCPExternalAuthConfig
            properties:
              configHash:
                description: ConfigHash is a hash of the current configuration for
                  change detection
                type: string
              observedGeneration:
                description: |-
                  ObservedGeneration is the most recent generation observed for this MCPExternalAuthConfig.
                  It corresponds to the MCPExternalAuthConfig's generation, which is updated on mutation by the API Server.
                format: int64
                type: integer
              referencingServers:
                description: |-
                  ReferencingServers is a list of MCPServer resources that reference this MCPExternalAuthConfig
                  This helps track which servers need to be reconciled when this config changes
                items:
                  type: string
                type: array
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
