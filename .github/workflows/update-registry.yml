name: Update Registry

on:
  schedule:
    # Run once a day at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  update-registry:
    name: Update Registry
    runs-on: ubuntu-slim
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Get latest registry release
        id: get-release
        run: |
          # Get the latest release info using gh CLI
          RELEASE_INFO=$(gh release view --repo stacklok/toolhive-registry --json tagName,assets)
          RELEASE_TAG=$(echo "$RELEASE_INFO" | jq -r '.tagName')
          
          # Check if registry.json asset exists
          REGISTRY_ASSET=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name == "registry.json")')
          if [ "$REGISTRY_ASSET" = "" ]; then
            echo "Error: Could not find registry.json asset in latest release"
            exit 1
          fi
          
          # Check if checksum asset exists
          CHECKSUM_ASSET=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name == "registry.json.sha256")')
          HAS_CHECKSUM=$([ "$CHECKSUM_ASSET" != "" ] && echo "true" || echo "false")
          
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "has_checksum=$HAS_CHECKSUM" >> $GITHUB_OUTPUT
          echo "Found registry.json in release $RELEASE_TAG"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download and validate registry
        id: update
        run: |
          # Download the registry.json using gh CLI
          gh release download "${{ steps.get-release.outputs.release_tag }}" \
            --repo stacklok/toolhive-registry \
            --pattern "registry.json*" \
            --dir /tmp
          
          # Verify checksum if available
          if [ "${{ steps.get-release.outputs.has_checksum }}" = "true" ]; then
            echo "Verifying checksum..."
            pushd /tmp
            sha256sum -c registry.json.sha256
            popd
            echo "✅ Checksum verification passed"
          else
            echo "⚠️ No checksum available for verification"
          fi
          
          # Basic JSON validation
          if ! jq empty /tmp/registry.json; then
            echo "Error: Downloaded registry.json is not valid JSON"
            exit 1
          fi
          echo "✅ Valid JSON structure"
          
          # Count servers for informational purposes
          CONTAINER_COUNT=$(jq '.servers | length' /tmp/registry.json)
          REMOTE_COUNT=$(jq '.remote_servers | length // 0' /tmp/registry.json)
          TOTAL_COUNT=$((CONTAINER_COUNT + REMOTE_COUNT))
          
          if [ "$TOTAL_COUNT" -eq 0 ]; then
            echo "Error: Registry contains no servers"
            exit 1
          fi
          
          echo "✅ Registry contains $TOTAL_COUNT servers ($CONTAINER_COUNT container-based, $REMOTE_COUNT remote)"
          
          # Check if the file is different from current
          if cmp -s /tmp/registry.json pkg/registry/data/registry.json; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes to the registry"
          else
            # Replace the current registry.json
            cp /tmp/registry.json pkg/registry/data/registry.json
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "server_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
            echo "Registry updated from release ${{ steps.get-release.outputs.release_tag }}"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        if: steps.update.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update registry from toolhive-registry release ${{ steps.get-release.outputs.release_tag }}"
          title: "Update registry from toolhive-registry release ${{ steps.get-release.outputs.release_tag }}"
          body: |
            This PR updates the registry.json file from the latest release of the [toolhive-registry](https://github.com/stacklok/toolhive-registry) repository.
            
            **Release**: ${{ steps.get-release.outputs.release_tag }}
            **Servers**: ${{ steps.update.outputs.server_count }}
            **Checksum verified**: ${{ steps.get-release.outputs.has_checksum == 'true' && '✅' || '⚠️ No checksum available' }}
            
            ## Changes

            - Registry synchronized from external repository
            - All server definitions and metadata updated
            - Provenance and security information maintained by upstream
          branch: update-registry-from-release
          base: main
          delete-branch: true
