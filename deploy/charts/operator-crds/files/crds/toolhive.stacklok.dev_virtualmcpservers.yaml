---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.17.3
  name: virtualmcpservers.toolhive.stacklok.dev
spec:
  group: toolhive.stacklok.dev
  names:
    kind: VirtualMCPServer
    listKind: VirtualMCPServerList
    plural: virtualmcpservers
    shortNames:
    - vmcp
    - virtualmcp
    singular: virtualmcpserver
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - description: The phase of the VirtualMCPServer
      jsonPath: .status.phase
      name: Phase
      type: string
    - description: Virtual MCP server URL
      jsonPath: .status.url
      name: URL
      type: string
    - description: Discovered backends count
      jsonPath: .status.backendCount
      name: Backends
      type: integer
    - description: Age
      jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    - jsonPath: .status.conditions[?(@.type=='Ready')].status
      name: Ready
      type: string
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          VirtualMCPServer is the Schema for the virtualmcpservers API
          VirtualMCPServer aggregates multiple backend MCPServers into a unified endpoint
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: VirtualMCPServerSpec defines the desired state of VirtualMCPServer
            properties:
              config:
                description: |-
                  Config is the Virtual MCP server configuration
                  The only field currently required within config is `config.groupRef`.
                  GroupRef references an existing MCPGroup that defines backend workloads.
                  The referenced MCPGroup must exist in the same namespace.
                  The telemetry and audit config from here are also supported, but not required.
                properties:
                  aggregation:
                    description: |-
                      Aggregation defines tool aggregation and conflict resolution strategies.
                      Supports ToolConfigRef for Kubernetes-native MCPToolConfig resource references.
                    properties:
                      conflictResolution:
                        default: prefix
                        description: |-
                          ConflictResolution defines the strategy for resolving tool name conflicts.
                          - prefix: Automatically prefix tool names with workload identifier
                          - priority: First workload in priority order wins
                          - manual: Explicitly define overrides for all conflicts
                        enum:
                        - prefix
                        - priority
                        - manual
                        type: string
                      conflictResolutionConfig:
                        description: ConflictResolutionConfig provides configuration
                          for the chosen strategy.
                        properties:
                          prefixFormat:
                            default: '{workload}_'
                            description: |-
                              PrefixFormat defines the prefix format for the "prefix" strategy.
                              Supports placeholders: {workload}, {workload}_, {workload}.
                            type: string
                          priorityOrder:
                            description: PriorityOrder defines the workload priority
                              order for the "priority" strategy.
                            items:
                              type: string
                            type: array
                        type: object
                      excludeAllTools:
                        description: ExcludeAllTools excludes all tools from aggregation
                          when true.
                        type: boolean
                      tools:
                        description: Tools defines per-workload tool filtering and
                          overrides.
                        items:
                          description: WorkloadToolConfig defines tool filtering and
                            overrides for a specific workload.
                          properties:
                            excludeAll:
                              description: ExcludeAll excludes all tools from this
                                workload when true.
                              type: boolean
                            filter:
                              description: |-
                                Filter is an inline list of tool names to allow (allow list).
                                Only used if ToolConfigRef is not specified.
                              items:
                                type: string
                              type: array
                            overrides:
                              additionalProperties:
                                description: ToolOverride defines tool name and description
                                  overrides.
                                properties:
                                  description:
                                    description: Description is the new tool description.
                                    type: string
                                  name:
                                    description: Name is the new tool name (for renaming).
                                    type: string
                                type: object
                              description: |-
                                Overrides is an inline map of tool overrides.
                                Only used if ToolConfigRef is not specified.
                              type: object
                            toolConfigRef:
                              description: |-
                                ToolConfigRef references an MCPToolConfig resource for tool filtering and renaming.
                                If specified, Filter and Overrides are ignored.
                                Only used when running in Kubernetes with the operator.
                              properties:
                                name:
                                  description: Name is the name of the MCPToolConfig
                                    resource in the same namespace.
                                  type: string
                              required:
                              - name
                              type: object
                            workload:
                              description: Workload is the name of the backend MCPServer
                                workload.
                              type: string
                          required:
                          - workload
                          type: object
                        type: array
                    type: object
                  audit:
                    description: |-
                      Audit configures audit logging for the Virtual MCP server.
                      When present, audit logs include MCP protocol operations.
                      See audit.Config for available configuration options.
                    properties:
                      component:
                        description: Component is the component name to use in audit
                          events.
                        type: string
                      enabled:
                        default: false
                        description: |-
                          Enabled controls whether audit logging is enabled.
                          When true, enables audit logging with the configured options.
                        type: boolean
                      eventTypes:
                        description: EventTypes specifies which event types to audit.
                          If empty, all events are audited.
                        items:
                          type: string
                        type: array
                      excludeEventTypes:
                        description: |-
                          ExcludeEventTypes specifies which event types to exclude from auditing.
                          This takes precedence over EventTypes.
                        items:
                          type: string
                        type: array
                      includeRequestData:
                        default: false
                        description: IncludeRequestData determines whether to include
                          request data in audit logs.
                        type: boolean
                      includeResponseData:
                        default: false
                        description: IncludeResponseData determines whether to include
                          response data in audit logs.
                        type: boolean
                      logFile:
                        description: LogFile specifies the file path for audit logs.
                          If empty, logs to stdout.
                        type: string
                      maxDataSize:
                        default: 1024
                        description: MaxDataSize limits the size of request/response
                          data included in audit logs (in bytes).
                        type: integer
                    type: object
                  backends:
                    description: |-
                      Backends defines pre-configured backend servers for static mode.
                      When OutgoingAuth.Source is "inline", this field contains the full list of backend
                      servers with their URLs and transport types, eliminating the need for K8s API access.
                      When OutgoingAuth.Source is "discovered", this field is empty and backends are
                      discovered at runtime via Kubernetes API.
                    items:
                      description: |-
                        StaticBackendConfig defines a pre-configured backend server for static mode.
                        This allows vMCP to operate without Kubernetes API access by embedding all backend
                        information directly in the configuration.
                      properties:
                        metadata:
                          additionalProperties:
                            type: string
                          description: |-
                            Metadata is a custom key-value map for storing additional backend information
                            such as labels, tags, or other arbitrary data (e.g., "env": "prod", "region": "us-east-1").
                            This is NOT Kubernetes ObjectMeta - it's a simple string map for user-defined metadata.
                            Reserved keys: "group" is automatically set by vMCP and any user-provided value will be overridden.
                          type: object
                        name:
                          description: |-
                            Name is the backend identifier.
                            Must match the backend name from the MCPGroup for auth config resolution.
                          type: string
                        transport:
                          description: |-
                            Transport is the MCP transport protocol: "sse" or "streamable-http"
                            Only network transports supported by vMCP client are allowed.
                          enum:
                          - sse
                          - streamable-http
                          type: string
                        url:
                          description: URL is the backend's MCP server base URL.
                          pattern: ^https?://
                          type: string
                      required:
                      - name
                      - transport
                      - url
                      type: object
                    type: array
                  compositeToolRefs:
                    description: |-
                      CompositeToolRefs references VirtualMCPCompositeToolDefinition resources
                      for complex, reusable workflows. Only applicable when running in Kubernetes.
                      Referenced resources must be in the same namespace as the VirtualMCPServer.
                    items:
                      description: |-
                        CompositeToolRef defines a reference to a VirtualMCPCompositeToolDefinition resource.
                        The referenced resource must be in the same namespace as the VirtualMCPServer.
                      properties:
                        name:
                          description: Name is the name of the VirtualMCPCompositeToolDefinition
                            resource in the same namespace.
                          type: string
                      required:
                      - name
                      type: object
                    type: array
                  compositeTools:
                    description: |-
                      CompositeTools defines inline composite tool workflows.
                      Full workflow definitions are embedded in the configuration.
                      For Kubernetes, complex workflows can also reference VirtualMCPCompositeToolDefinition CRDs.
                    items:
                      description: |-
                        CompositeToolConfig defines a composite tool workflow.
                        This matches the YAML structure from the proposal (lines 173-255).
                      properties:
                        description:
                          description: Description describes what the workflow does.
                          type: string
                        name:
                          description: Name is the workflow name (unique identifier).
                          type: string
                        output:
                          description: |-
                            Output defines the structured output schema for this workflow.
                            If not specified, the workflow returns the last step's output (backward compatible).
                          properties:
                            properties:
                              additionalProperties:
                                description: |-
                                  OutputProperty defines a single output property.
                                  For non-object types, Value is required.
                                  For object types, either Value or Properties must be specified (but not both).
                                properties:
                                  default:
                                    description: |-
                                      Default is the fallback value if template expansion fails.
                                      Type coercion is applied to match the declared Type.
                                    x-kubernetes-preserve-unknown-fields: true
                                  description:
                                    description: Description is a human-readable description
                                      exposed to clients and models
                                    type: string
                                  properties:
                                    description: |-
                                      Properties defines nested properties for object types.
                                      Each nested property has full metadata (type, description, value/properties).
                                    type: object
                                    x-kubernetes-preserve-unknown-fields: true
                                  type:
                                    description: 'Type is the JSON Schema type: "string",
                                      "integer", "number", "boolean", "object", "array"'
                                    enum:
                                    - string
                                    - integer
                                    - number
                                    - boolean
                                    - object
                                    - array
                                    type: string
                                  value:
                                    description: |-
                                      Value is a template string for constructing the runtime value.
                                      For object types, this can be a JSON string that will be deserialized.
                                      Supports template syntax: {{.steps.step_id.output.field}}, {{.params.param_name}}
                                    type: string
                                required:
                                - type
                                type: object
                              description: |-
                                Properties defines the output properties.
                                Map key is the property name, value is the property definition.
                              type: object
                            required:
                              description: Required lists property names that must
                                be present in the output.
                              items:
                                type: string
                              type: array
                          required:
                          - properties
                          type: object
                        parameters:
                          description: |-
                            Parameters defines input parameter schema in JSON Schema format.
                            Should be a JSON Schema object with "type": "object" and "properties".
                            Example:
                              {
                                "type": "object",
                                "properties": {
                                  "param1": {"type": "string", "default": "value"},
                                  "param2": {"type": "integer"}
                                },
                                "required": ["param2"]
                              }

                            We use json.Map rather than a typed struct because JSON Schema is highly
                            flexible with many optional fields (default, enum, minimum, maximum, pattern,
                            items, additionalProperties, oneOf, anyOf, allOf, etc.). Using json.Map
                            allows full JSON Schema compatibility without needing to define every possible
                            field, and matches how the MCP SDK handles inputSchema.
                          type: object
                          x-kubernetes-preserve-unknown-fields: true
                        steps:
                          description: Steps are the workflow steps to execute.
                          items:
                            description: |-
                              WorkflowStepConfig defines a single workflow step.
                              This matches the proposal's step configuration (lines 180-255).
                            properties:
                              arguments:
                                description: |-
                                  Arguments is a map of argument values with template expansion support.
                                  Supports Go template syntax with .params and .steps for string values.
                                  Non-string values (integers, booleans, arrays, objects) are passed as-is.
                                  Note: the templating is only supported on the first level of the key-value pairs.
                                type: object
                                x-kubernetes-preserve-unknown-fields: true
                              condition:
                                description: Condition is a template expression that
                                  determines if the step should execute
                                type: string
                              defaultResults:
                                description: |-
                                  DefaultResults provides fallback output values when this step is skipped
                                  (due to condition evaluating to false) or fails (when onError.action is "continue").
                                  Each key corresponds to an output field name referenced by downstream steps.
                                  Required if the step may be skipped AND downstream steps reference this step's output.
                                x-kubernetes-preserve-unknown-fields: true
                              dependsOn:
                                description: DependsOn lists step IDs that must complete
                                  before this step
                                items:
                                  type: string
                                type: array
                              id:
                                description: ID is the unique identifier for this
                                  step.
                                type: string
                              message:
                                description: |-
                                  Message is the elicitation message
                                  Only used when Type is "elicitation"
                                type: string
                              onCancel:
                                description: |-
                                  OnCancel defines the action to take when the user cancels/dismisses the elicitation
                                  Only used when Type is "elicitation"
                                properties:
                                  action:
                                    default: abort
                                    description: |-
                                      Action defines the action to take when the user declines or cancels
                                      - skip_remaining: Skip remaining steps in the workflow
                                      - abort: Abort the entire workflow execution
                                      - continue: Continue to the next step
                                    enum:
                                    - skip_remaining
                                    - abort
                                    - continue
                                    type: string
                                type: object
                              onDecline:
                                description: |-
                                  OnDecline defines the action to take when the user explicitly declines the elicitation
                                  Only used when Type is "elicitation"
                                properties:
                                  action:
                                    default: abort
                                    description: |-
                                      Action defines the action to take when the user declines or cancels
                                      - skip_remaining: Skip remaining steps in the workflow
                                      - abort: Abort the entire workflow execution
                                      - continue: Continue to the next step
                                    enum:
                                    - skip_remaining
                                    - abort
                                    - continue
                                    type: string
                                type: object
                              onError:
                                description: OnError defines error handling behavior
                                properties:
                                  action:
                                    default: abort
                                    description: Action defines the action to take
                                      on error
                                    enum:
                                    - abort
                                    - continue
                                    - retry
                                    type: string
                                  retryCount:
                                    description: |-
                                      RetryCount is the maximum number of retries
                                      Only used when Action is "retry"
                                    type: integer
                                  retryDelay:
                                    description: |-
                                      RetryDelay is the delay between retry attempts
                                      Only used when Action is "retry"
                                    pattern: ^([0-9]+(\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$
                                    type: string
                                type: object
                              schema:
                                description: Schema defines the expected response
                                  schema for elicitation
                                type: object
                                x-kubernetes-preserve-unknown-fields: true
                              timeout:
                                description: Timeout is the maximum execution time
                                  for this step
                                pattern: ^([0-9]+(\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$
                                type: string
                              tool:
                                description: |-
                                  Tool is the tool to call (format: "workload.tool_name")
                                  Only used when Type is "tool"
                                type: string
                              type:
                                default: tool
                                description: Type is the step type (tool, elicitation,
                                  etc.)
                                enum:
                                - tool
                                - elicitation
                                type: string
                            required:
                            - id
                            type: object
                          type: array
                        timeout:
                          description: Timeout is the maximum workflow execution time.
                          pattern: ^([0-9]+(\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$
                          type: string
                      required:
                      - name
                      - steps
                      type: object
                    type: array
                  groupRef:
                    description: |-
                      Group references an existing MCPGroup that defines backend workloads.
                      In Kubernetes, the referenced MCPGroup must exist in the same namespace.
                    type: string
                  incomingAuth:
                    description: |-
                      IncomingAuth configures how clients authenticate to the virtual MCP server.
                      When using the Kubernetes operator, this is populated by the converter from
                      VirtualMCPServerSpec.IncomingAuth and any values set here will be superseded.
                    properties:
                      authz:
                        description: Authz contains authorization configuration (optional).
                        properties:
                          policies:
                            description: Policies contains Cedar policy definitions
                              (when Type = "cedar").
                            items:
                              type: string
                            type: array
                          type:
                            description: 'Type is the authz type: "cedar", "none"'
                            type: string
                        required:
                        - type
                        type: object
                      oidc:
                        description: OIDC contains OIDC configuration (when Type =
                          "oidc").
                        properties:
                          audience:
                            description: Audience is the required token audience.
                            type: string
                          clientId:
                            description: ClientID is the OAuth client ID.
                            type: string
                          clientSecretEnv:
                            description: |-
                              ClientSecretEnv is the name of the environment variable containing the client secret.
                              This is the secure way to reference secrets - the actual secret value is never stored
                              in configuration files, only the environment variable name.
                              The secret value will be resolved from this environment variable at runtime.
                            type: string
                          insecureAllowHttp:
                            description: |-
                              InsecureAllowHTTP allows HTTP (non-HTTPS) OIDC issuers for development/testing
                              WARNING: This is insecure and should NEVER be used in production
                            type: boolean
                          issuer:
                            description: Issuer is the OIDC issuer URL.
                            pattern: ^https?://
                            type: string
                          protectedResourceAllowPrivateIp:
                            description: |-
                              ProtectedResourceAllowPrivateIP allows protected resource endpoint on private IP addresses
                              Use with caution - only enable for trusted internal IDPs or testing
                            type: boolean
                          resource:
                            description: |-
                              Resource is the OAuth 2.0 resource indicator (RFC 8707).
                              Used in WWW-Authenticate header and OAuth discovery metadata (RFC 9728).
                              If not specified, defaults to Audience.
                            type: string
                          scopes:
                            description: Scopes are the required OAuth scopes.
                            items:
                              type: string
                            type: array
                        required:
                        - audience
                        - clientId
                        - issuer
                        type: object
                      type:
                        description: 'Type is the auth type: "oidc", "local", "anonymous"'
                        type: string
                    required:
                    - type
                    type: object
                  metadata:
                    additionalProperties:
                      type: string
                    description: Metadata stores additional configuration metadata.
                    type: object
                  name:
                    description: Name is the virtual MCP server name.
                    type: string
                  operational:
                    description: Operational configures operational settings.
                    properties:
                      failureHandling:
                        description: FailureHandling configures failure handling behavior.
                        properties:
                          circuitBreaker:
                            description: CircuitBreaker configures circuit breaker
                              behavior.
                            properties:
                              enabled:
                                default: false
                                description: Enabled controls whether circuit breaker
                                  is enabled.
                                type: boolean
                              failureThreshold:
                                default: 5
                                description: FailureThreshold is the number of failures
                                  before opening the circuit.
                                type: integer
                              timeout:
                                default: 60s
                                description: Timeout is the duration to wait before
                                  attempting to close the circuit.
                                pattern: ^([0-9]+(\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$
                                type: string
                            type: object
                          healthCheckInterval:
                            default: 30s
                            description: HealthCheckInterval is the interval between
                              health checks.
                            pattern: ^([0-9]+(\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$
                            type: string
                          partialFailureMode:
                            default: fail
                            description: |-
                              PartialFailureMode defines behavior when some backends are unavailable.
                              - fail: Fail entire request if any backend is unavailable
                              - best_effort: Continue with available backends
                            enum:
                            - fail
                            - best_effort
                            type: string
                          unhealthyThreshold:
                            default: 3
                            description: UnhealthyThreshold is the number of consecutive
                              failures before marking unhealthy.
                            type: integer
                        type: object
                      logLevel:
                        description: |-
                          LogLevel sets the logging level for the Virtual MCP server.
                          The only valid value is "debug" to enable debug logging.
                          When omitted or empty, the server uses info level logging.
                        enum:
                        - debug
                        type: string
                      timeouts:
                        description: Timeouts configures timeout settings.
                        properties:
                          default:
                            default: 30s
                            description: Default is the default timeout for backend
                              requests.
                            pattern: ^([0-9]+(\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$
                            type: string
                          perWorkload:
                            additionalProperties:
                              pattern: ^([0-9]+(\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$
                              type: string
                            description: PerWorkload defines per-workload timeout
                              overrides.
                            type: object
                        type: object
                    type: object
                  optimizer:
                    description: |-
                      Optimizer configures the MCP optimizer for context optimization on large toolsets.
                      When enabled, vMCP exposes optim.find_tool and optim.call_tool operations to clients
                      instead of all backend tools directly. This reduces token usage by allowing
                      LLMs to discover relevant tools on demand rather than receiving all tool definitions.
                    properties:
                      embeddingBackend:
                        description: |-
                          EmbeddingBackend specifies the embedding provider: "ollama", "openai-compatible", or "placeholder".
                          - "ollama": Uses local Ollama HTTP API for embeddings
                          - "openai-compatible": Uses OpenAI-compatible API (vLLM, OpenAI, etc.)
                          - "placeholder": Uses deterministic hash-based embeddings (for testing/development)
                        enum:
                        - ollama
                        - openai-compatible
                        - placeholder
                        type: string
                      embeddingDimension:
                        description: |-
                          EmbeddingDimension is the dimension of the embedding vectors.
                          Common values:
                          - 384: all-MiniLM-L6-v2, nomic-embed-text
                          - 768: BAAI/bge-small-en-v1.5
                          - 1536: OpenAI text-embedding-3-small
                        minimum: 1
                        type: integer
                      embeddingModel:
                        description: |-
                          EmbeddingModel is the model name to use for embeddings.
                          Required when EmbeddingBackend is "ollama" or "openai-compatible".
                          Examples:
                          - Ollama: "nomic-embed-text", "all-minilm"
                          - vLLM: "BAAI/bge-small-en-v1.5"
                          - OpenAI: "text-embedding-3-small"
                        type: string
                      embeddingURL:
                        description: |-
                          EmbeddingURL is the base URL for the embedding service (Ollama or OpenAI-compatible API).
                          Required when EmbeddingBackend is "ollama" or "openai-compatible".
                          Examples:
                          - Ollama: "http://localhost:11434"
                          - vLLM: "http://vllm-service:8000/v1"
                          - OpenAI: "https://api.openai.com/v1"
                        type: string
                      enabled:
                        description: |-
                          Enabled determines whether the optimizer is active.
                          When true, vMCP exposes optim.find_tool and optim.call_tool instead of all backend tools.
                        type: boolean
                      ftsDBPath:
                        description: |-
                          FTSDBPath is the path to the SQLite FTS5 database for BM25 text search.
                          If empty, defaults to ":memory:" for in-memory FTS5, or "{PersistPath}/fts.db" if PersistPath is set.
                          Hybrid search (semantic + BM25) is always enabled.
                        type: string
                      hybridSearchRatio:
                        description: |-
                          HybridSearchRatio controls the mix of semantic vs BM25 results in hybrid search.
                          Value range: 0.0 (all BM25) to 1.0 (all semantic).
                          Default: 0.7 (70% semantic, 30% BM25)
                          Only used when FTSDBPath is set.
                        maximum: 1
                        minimum: 0
                        type: number
                      persistPath:
                        description: |-
                          PersistPath is the optional filesystem path for persisting the chromem-go database.
                          If empty, the database will be in-memory only (ephemeral).
                          When set, tool metadata and embeddings are persisted to disk for faster restarts.
                        type: string
                    type: object
                  outgoingAuth:
                    description: |-
                      OutgoingAuth configures how the virtual MCP server authenticates to backends.
                      When using the Kubernetes operator, this is populated by the converter from
                      VirtualMCPServerSpec.OutgoingAuth and any values set here will be superseded.
                    properties:
                      backends:
                        additionalProperties:
                          description: |-
                            BackendAuthStrategy defines how to authenticate to a specific backend.

                            This struct provides type-safe configuration for different authentication strategies
                            using HeaderInjection or TokenExchange fields based on the Type field.
                          properties:
                            headerInjection:
                              description: |-
                                HeaderInjection contains configuration for header injection auth strategy.
                                Used when Type = "header_injection".
                              properties:
                                headerName:
                                  description: HeaderName is the name of the header
                                    to inject (e.g., "Authorization").
                                  type: string
                                headerValue:
                                  description: |-
                                    HeaderValue is the static header value to inject.
                                    Either HeaderValue or HeaderValueEnv should be set, not both.
                                  type: string
                                headerValueEnv:
                                  description: |-
                                    HeaderValueEnv is the environment variable name containing the header value.
                                    The value will be resolved at runtime from this environment variable.
                                    Either HeaderValue or HeaderValueEnv should be set, not both.
                                  type: string
                              required:
                              - headerName
                              type: object
                            tokenExchange:
                              description: |-
                                TokenExchange contains configuration for token exchange auth strategy.
                                Used when Type = "token_exchange".
                              properties:
                                audience:
                                  description: Audience is the target audience for
                                    the exchanged token.
                                  type: string
                                clientId:
                                  description: ClientID is the OAuth client ID for
                                    the token exchange request.
                                  type: string
                                clientSecret:
                                  description: ClientSecret is the OAuth client secret
                                    (use ClientSecretEnv for security).
                                  type: string
                                clientSecretEnv:
                                  description: |-
                                    ClientSecretEnv is the environment variable name containing the client secret.
                                    The value will be resolved at runtime from this environment variable.
                                  type: string
                                scopes:
                                  description: Scopes are the requested scopes for
                                    the exchanged token.
                                  items:
                                    type: string
                                  type: array
                                subjectTokenType:
                                  description: |-
                                    SubjectTokenType is the token type of the incoming subject token.
                                    Defaults to "urn:ietf:params:oauth:token-type:access_token" if not specified.
                                  type: string
                                tokenUrl:
                                  description: TokenURL is the OAuth token endpoint
                                    URL for token exchange.
                                  type: string
                              required:
                              - tokenUrl
                              type: object
                            type:
                              description: 'Type is the auth strategy: "unauthenticated",
                                "header_injection", "token_exchange"'
                              type: string
                          required:
                          - type
                          type: object
                        description: Backends contains per-backend auth configuration.
                        type: object
                      default:
                        description: Default is the default auth strategy for backends
                          without explicit config.
                        properties:
                          headerInjection:
                            description: |-
                              HeaderInjection contains configuration for header injection auth strategy.
                              Used when Type = "header_injection".
                            properties:
                              headerName:
                                description: HeaderName is the name of the header
                                  to inject (e.g., "Authorization").
                                type: string
                              headerValue:
                                description: |-
                                  HeaderValue is the static header value to inject.
                                  Either HeaderValue or HeaderValueEnv should be set, not both.
                                type: string
                              headerValueEnv:
                                description: |-
                                  HeaderValueEnv is the environment variable name containing the header value.
                                  The value will be resolved at runtime from this environment variable.
                                  Either HeaderValue or HeaderValueEnv should be set, not both.
                                type: string
                            required:
                            - headerName
                            type: object
                          tokenExchange:
                            description: |-
                              TokenExchange contains configuration for token exchange auth strategy.
                              Used when Type = "token_exchange".
                            properties:
                              audience:
                                description: Audience is the target audience for the
                                  exchanged token.
                                type: string
                              clientId:
                                description: ClientID is the OAuth client ID for the
                                  token exchange request.
                                type: string
                              clientSecret:
                                description: ClientSecret is the OAuth client secret
                                  (use ClientSecretEnv for security).
                                type: string
                              clientSecretEnv:
                                description: |-
                                  ClientSecretEnv is the environment variable name containing the client secret.
                                  The value will be resolved at runtime from this environment variable.
                                type: string
                              scopes:
                                description: Scopes are the requested scopes for the
                                  exchanged token.
                                items:
                                  type: string
                                type: array
                              subjectTokenType:
                                description: |-
                                  SubjectTokenType is the token type of the incoming subject token.
                                  Defaults to "urn:ietf:params:oauth:token-type:access_token" if not specified.
                                type: string
                              tokenUrl:
                                description: TokenURL is the OAuth token endpoint
                                  URL for token exchange.
                                type: string
                            required:
                            - tokenUrl
                            type: object
                          type:
                            description: 'Type is the auth strategy: "unauthenticated",
                              "header_injection", "token_exchange"'
                            type: string
                        required:
                        - type
                        type: object
                      source:
                        description: |-
                          Source defines how to discover backend auth: "inline", "discovered"
                          - inline: Explicit configuration in OutgoingAuth
                          - discovered: Auto-discover from backend MCPServer.externalAuthConfigRef (Kubernetes only)
                        type: string
                    required:
                    - source
                    type: object
                  telemetry:
                    description: |-
                      Telemetry configures OpenTelemetry-based observability for the Virtual MCP server
                      including distributed tracing, OTLP metrics export, and Prometheus metrics endpoint.
                    properties:
                      customAttributes:
                        additionalProperties:
                          type: string
                        description: |-
                          CustomAttributes contains custom resource attributes to be added to all telemetry signals.
                          These are parsed from CLI flags (--otel-custom-attributes) or environment variables
                          (OTEL_RESOURCE_ATTRIBUTES) as key=value pairs.
                        type: object
                      enablePrometheusMetricsPath:
                        default: false
                        description: |-
                          EnablePrometheusMetricsPath controls whether to expose Prometheus-style /metrics endpoint.
                          The metrics are served on the main transport port at /metrics.
                          This is separate from OTLP metrics which are sent to the Endpoint.
                        type: boolean
                      endpoint:
                        description: Endpoint is the OTLP endpoint URL
                        type: string
                      environmentVariables:
                        description: |-
                          EnvironmentVariables is a list of environment variable names that should be
                          included in telemetry spans as attributes. Only variables in this list will
                          be read from the host machine and included in spans for observability.
                          Example: ["NODE_ENV", "DEPLOYMENT_ENV", "SERVICE_VERSION"]
                        items:
                          type: string
                        type: array
                      headers:
                        additionalProperties:
                          type: string
                        description: Headers contains authentication headers for the
                          OTLP endpoint.
                        type: object
                      insecure:
                        default: false
                        description: Insecure indicates whether to use HTTP instead
                          of HTTPS for the OTLP endpoint.
                        type: boolean
                      metricsEnabled:
                        default: false
                        description: |-
                          MetricsEnabled controls whether OTLP metrics are enabled.
                          When false, OTLP metrics are not sent even if an endpoint is configured.
                          This is independent of EnablePrometheusMetricsPath.
                        type: boolean
                      samplingRate:
                        default: "0.05"
                        description: |-
                          SamplingRate is the trace sampling rate (0.0-1.0) as a string.
                          Only used when TracingEnabled is true.
                          Example: "0.05" for 5% sampling.
                        type: string
                      serviceName:
                        description: |-
                          ServiceName is the service name for telemetry.
                          When omitted, defaults to the server name (e.g., VirtualMCPServer name).
                        type: string
                      serviceVersion:
                        description: |-
                          ServiceVersion is the service version for telemetry.
                          When omitted, defaults to the ToolHive version.
                        type: string
                      tracingEnabled:
                        default: false
                        description: |-
                          TracingEnabled controls whether distributed tracing is enabled.
                          When false, no tracer provider is created even if an endpoint is configured.
                        type: boolean
                    type: object
                required:
                - groupRef
                type: object
                x-kubernetes-preserve-unknown-fields: true
              incomingAuth:
                description: |-
                  IncomingAuth configures authentication for clients connecting to the Virtual MCP server.
                  Must be explicitly set - use "anonymous" type when no authentication is required.
                  This field takes precedence over config.IncomingAuth and should be preferred because it
                  supports Kubernetes-native secret references (SecretKeyRef, ConfigMapRef) for secure
                  dynamic discovery of credentials, rather than requiring secrets to be embedded in config.
                properties:
                  authzConfig:
                    description: |-
                      AuthzConfig defines authorization policy configuration
                      Reuses MCPServer authz patterns
                    properties:
                      configMap:
                        description: |-
                          ConfigMap references a ConfigMap containing authorization configuration
                          Only used when Type is "configMap"
                        properties:
                          key:
                            default: authz.json
                            description: Key is the key in the ConfigMap that contains
                              the authorization configuration
                            type: string
                          name:
                            description: Name is the name of the ConfigMap
                            type: string
                        required:
                        - name
                        type: object
                      inline:
                        description: |-
                          Inline contains direct authorization configuration
                          Only used when Type is "inline"
                        properties:
                          entitiesJson:
                            default: '[]'
                            description: EntitiesJSON is a JSON string representing
                              Cedar entities
                            type: string
                          policies:
                            description: Policies is a list of Cedar policy strings
                            items:
                              type: string
                            minItems: 1
                            type: array
                        required:
                        - policies
                        type: object
                      type:
                        default: configMap
                        description: Type is the type of authorization configuration
                        enum:
                        - configMap
                        - inline
                        type: string
                    required:
                    - type
                    type: object
                  oidcConfig:
                    description: |-
                      OIDCConfig defines OIDC authentication configuration
                      Reuses MCPServer OIDC patterns
                    properties:
                      configMap:
                        description: |-
                          ConfigMap references a ConfigMap containing OIDC configuration
                          Only used when Type is "configmap"
                        properties:
                          caBundleRef:
                            description: |-
                              CABundleRef references a ConfigMap containing the CA certificate bundle.
                              When specified, ToolHive auto-mounts the ConfigMap and auto-computes ThvCABundlePath.
                              If the ConfigMap data contains an explicit thvCABundlePath key, it takes precedence.
                            properties:
                              configMapRef:
                                description: |-
                                  ConfigMapRef references a ConfigMap containing the CA certificate bundle.
                                  If Key is not specified, it defaults to "ca.crt".
                                properties:
                                  key:
                                    description: The key to select.
                                    type: string
                                  name:
                                    default: ""
                                    description: |-
                                      Name of the referent.
                                      This field is effectively required, but due to backwards compatibility is
                                      allowed to be empty. Instances of this type with an empty value here are
                                      almost certainly wrong.
                                      More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names
                                    type: string
                                  optional:
                                    description: Specify whether the ConfigMap or
                                      its key must be defined
                                    type: boolean
                                required:
                                - key
                                type: object
                                x-kubernetes-map-type: atomic
                            type: object
                          key:
                            default: oidc.json
                            description: Key is the key in the ConfigMap that contains
                              the OIDC configuration
                            type: string
                          name:
                            description: Name is the name of the ConfigMap
                            type: string
                        required:
                        - name
                        type: object
                      inline:
                        description: |-
                          Inline contains direct OIDC configuration
                          Only used when Type is "inline"
                        properties:
                          audience:
                            description: Audience is the expected audience for the
                              token
                            type: string
                          caBundleRef:
                            description: |-
                              CABundleRef references a ConfigMap containing the CA certificate bundle.
                              When specified, ToolHive auto-mounts the ConfigMap and auto-computes ThvCABundlePath.
                              If ThvCABundlePath is explicitly set, it takes precedence over CABundleRef.
                            properties:
                              configMapRef:
                                description: |-
                                  ConfigMapRef references a ConfigMap containing the CA certificate bundle.
                                  If Key is not specified, it defaults to "ca.crt".
                                properties:
                                  key:
                                    description: The key to select.
                                    type: string
                                  name:
                                    default: ""
                                    description: |-
                                      Name of the referent.
                                      This field is effectively required, but due to backwards compatibility is
                                      allowed to be empty. Instances of this type with an empty value here are
                                      almost certainly wrong.
                                      More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names
                                    type: string
                                  optional:
                                    description: Specify whether the ConfigMap or
                                      its key must be defined
                                    type: boolean
                                required:
                                - key
                                type: object
                                x-kubernetes-map-type: atomic
                            type: object
                          clientId:
                            description: ClientID is the OIDC client ID
                            type: string
                          clientSecret:
                            description: |-
                              ClientSecret is the client secret for introspection (optional)
                              Deprecated: Use ClientSecretRef instead for better security
                            type: string
                          clientSecretRef:
                            description: |-
                              ClientSecretRef is a reference to a Kubernetes Secret containing the client secret
                              If both ClientSecret and ClientSecretRef are provided, ClientSecretRef takes precedence
                            properties:
                              key:
                                description: Key is the key within the secret
                                type: string
                              name:
                                description: Name is the name of the secret
                                type: string
                            required:
                            - key
                            - name
                            type: object
                          insecureAllowHTTP:
                            default: false
                            description: |-
                              InsecureAllowHTTP allows HTTP (non-HTTPS) OIDC issuers for development/testing
                              WARNING: This is insecure and should NEVER be used in production
                              Only enable for local development, testing, or trusted internal networks
                            type: boolean
                          introspectionUrl:
                            description: IntrospectionURL is the URL for token introspection
                              endpoint
                            type: string
                          issuer:
                            description: Issuer is the OIDC issuer URL
                            type: string
                          jwksAllowPrivateIP:
                            default: false
                            description: |-
                              JWKSAllowPrivateIP allows JWKS/OIDC endpoints on private IP addresses
                              Use with caution - only enable for trusted internal IDPs
                            type: boolean
                          jwksAuthTokenPath:
                            description: |-
                              JWKSAuthTokenPath is the path to file containing bearer token for JWKS/OIDC requests
                              The file must be mounted into the pod (e.g., via Secret volume)
                            type: string
                          jwksUrl:
                            description: JWKSURL is the URL to fetch the JWKS from
                            type: string
                          protectedResourceAllowPrivateIP:
                            default: false
                            description: |-
                              ProtectedResourceAllowPrivateIP allows protected resource endpoint on private IP addresses
                              Use with caution - only enable for trusted internal IDPs or testing
                            type: boolean
                          scopes:
                            description: |-
                              Scopes is the list of OAuth scopes to advertise in the well-known endpoint (RFC 9728)
                              If empty, defaults to ["openid"]
                            items:
                              type: string
                            type: array
                          thvCABundlePath:
                            description: |-
                              ThvCABundlePath is the path to CA certificate bundle file for HTTPS requests.

                              Deprecated: Use CABundleRef instead. ThvCABundlePath requires the CA bundle to
                              already exist in the proxy runner container (e.g., Kubernetes service account CA at
                              /var/run/secrets/kubernetes.io/serviceaccount/ca.crt). For custom CA certificates,
                              use CABundleRef which automatically mounts the ConfigMap and computes the path.
                              This field will be removed when the API graduates to v1beta1.
                            type: string
                        required:
                        - issuer
                        type: object
                      kubernetes:
                        description: |-
                          Kubernetes configures OIDC for Kubernetes service account token validation
                          Only used when Type is "kubernetes"
                        properties:
                          audience:
                            default: toolhive
                            description: Audience is the expected audience for the
                              token
                            type: string
                          introspectionUrl:
                            description: |-
                              IntrospectionURL is the URL for token introspection endpoint
                              If empty, OIDC discovery will be used to automatically determine the introspection URL
                            type: string
                          issuer:
                            default: https://kubernetes.default.svc
                            description: Issuer is the OIDC issuer URL
                            type: string
                          jwksUrl:
                            description: |-
                              JWKSURL is the URL to fetch the JWKS from
                              If empty, OIDC discovery will be used to automatically determine the JWKS URL
                            type: string
                          namespace:
                            description: |-
                              Namespace is the namespace of the service account
                              If empty, uses the MCPServer's namespace
                            type: string
                          serviceAccount:
                            description: |-
                              ServiceAccount is the name of the service account to validate tokens for
                              If empty, uses the pod's service account
                            type: string
                          useClusterAuth:
                            description: |-
                              UseClusterAuth enables using the Kubernetes cluster's CA bundle and service account token
                              When true, uses /var/run/secrets/kubernetes.io/serviceaccount/ca.crt for TLS verification
                              and /var/run/secrets/kubernetes.io/serviceaccount/token for bearer token authentication
                              Defaults to true if not specified
                            type: boolean
                        type: object
                      resourceUrl:
                        description: |-
                          ResourceURL is the explicit resource URL for OAuth discovery endpoint (RFC 9728)
                          If not specified, defaults to the in-cluster Kubernetes service URL
                        type: string
                      type:
                        default: kubernetes
                        description: Type is the type of OIDC configuration
                        enum:
                        - kubernetes
                        - configMap
                        - inline
                        type: string
                    required:
                    - type
                    type: object
                  type:
                    description: |-
                      Type defines the authentication type: anonymous or oidc
                      When no authentication is required, explicitly set this to "anonymous"
                    enum:
                    - anonymous
                    - oidc
                    type: string
                required:
                - type
                type: object
              outgoingAuth:
                description: |-
                  OutgoingAuth configures authentication from Virtual MCP to backend MCPServers.
                  This field takes precedence over config.OutgoingAuth and should be preferred because it
                  supports Kubernetes-native secret references (SecretKeyRef, ConfigMapRef) for secure
                  dynamic discovery of credentials, rather than requiring secrets to be embedded in config.
                properties:
                  backends:
                    additionalProperties:
                      description: BackendAuthConfig defines authentication configuration
                        for a backend MCPServer
                      properties:
                        externalAuthConfigRef:
                          description: |-
                            ExternalAuthConfigRef references an MCPExternalAuthConfig resource
                            Only used when Type is "external_auth_config_ref"
                          properties:
                            name:
                              description: Name is the name of the MCPExternalAuthConfig
                                resource
                              type: string
                          required:
                          - name
                          type: object
                        type:
                          description: Type defines the authentication type
                          enum:
                          - discovered
                          - external_auth_config_ref
                          type: string
                      required:
                      - type
                      type: object
                    description: |-
                      Backends defines per-backend authentication overrides
                      Works in all modes (discovered, inline)
                    type: object
                  default:
                    description: Default defines default behavior for backends without
                      explicit auth config
                    properties:
                      externalAuthConfigRef:
                        description: |-
                          ExternalAuthConfigRef references an MCPExternalAuthConfig resource
                          Only used when Type is "external_auth_config_ref"
                        properties:
                          name:
                            description: Name is the name of the MCPExternalAuthConfig
                              resource
                            type: string
                        required:
                        - name
                        type: object
                      type:
                        description: Type defines the authentication type
                        enum:
                        - discovered
                        - external_auth_config_ref
                        type: string
                    required:
                    - type
                    type: object
                  source:
                    default: discovered
                    description: |-
                      Source defines how backend authentication configurations are determined
                      - discovered: Automatically discover from backend's MCPServer.spec.externalAuthConfigRef
                      - inline: Explicit per-backend configuration in VirtualMCPServer
                    enum:
                    - discovered
                    - inline
                    type: string
                type: object
              podTemplateSpec:
                description: |-
                  PodTemplateSpec defines the pod template to use for the Virtual MCP server
                  This allows for customizing the pod configuration beyond what is provided by the other fields.
                  Note that to modify the specific container the Virtual MCP server runs in, you must specify
                  the 'vmcp' container name in the PodTemplateSpec.
                  This field accepts a PodTemplateSpec object as JSON/YAML.
                type: object
                x-kubernetes-preserve-unknown-fields: true
              serviceType:
                default: ClusterIP
                description: ServiceType specifies the Kubernetes service type for
                  the Virtual MCP server
                enum:
                - ClusterIP
                - NodePort
                - LoadBalancer
                type: string
            required:
            - incomingAuth
            type: object
          status:
            description: VirtualMCPServerStatus defines the observed state of VirtualMCPServer
            properties:
              backendCount:
                description: BackendCount is the number of discovered backends
                type: integer
              conditions:
                description: Conditions represent the latest available observations
                  of the VirtualMCPServer's state
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
              discoveredBackends:
                description: DiscoveredBackends lists discovered backend configurations
                  from the MCPGroup
                items:
                  description: DiscoveredBackend represents a discovered backend MCPServer
                    in the MCPGroup
                  properties:
                    authConfigRef:
                      description: AuthConfigRef is the name of the discovered MCPExternalAuthConfig
                        (if any)
                      type: string
                    authType:
                      description: AuthType is the type of authentication configured
                      type: string
                    lastHealthCheck:
                      description: LastHealthCheck is the timestamp of the last health
                        check
                      format: date-time
                      type: string
                    name:
                      description: Name is the name of the backend MCPServer
                      type: string
                    status:
                      description: Status is the current status of the backend (ready,
                        degraded, unavailable)
                      type: string
                    url:
                      description: URL is the URL of the backend MCPServer
                      type: string
                  required:
                  - name
                  type: object
                type: array
              message:
                description: Message provides additional information about the current
                  phase
                type: string
              observedGeneration:
                description: ObservedGeneration is the most recent generation observed
                  for this VirtualMCPServer
                format: int64
                type: integer
              phase:
                default: Pending
                description: Phase is the current phase of the VirtualMCPServer
                enum:
                - Pending
                - Ready
                - Degraded
                - Failed
                type: string
              url:
                description: URL is the URL where the Virtual MCP server can be accessed
                type: string
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
