name: PR Size Enforcement - Apply

on:
  workflow_run:
    workflows: ["PR Size Enforcement - Check"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write

jobs:
  apply-xl-enforcement:
    name: Apply XL PR Enforcement
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Download artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4
        with:
          name: pr-enforcement-result
          path: pr-enforcement/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Read enforcement result
        id: read
        run: |
          cat pr-enforcement/result.json
          echo "result=$(cat pr-enforcement/result.json)" >> $GITHUB_OUTPUT

      - name: Request changes if no justification
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        env:
          RESULT_JSON: ${{ steps.read.outputs.result }}
        with:
          script: |
            const result = JSON.parse(process.env.RESULT_JSON);

            console.log('Enforcement result:', result);

            if (!result.needsEnforcement) {
              console.log('No enforcement needed, skipping');
              return;
            }

            const prNumber = result.prNumber;

            // Check if we already have a review requesting changes
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const botReview = reviews.data.find(review =>
              review.user.login === 'github-actions[bot]' &&
              review.state === 'CHANGES_REQUESTED'
            );

            if (botReview) {
              console.log('Already requested changes in review:', botReview.id);
              return;
            }

            // Read the message template from file
            const fs = require('fs');
            const template = fs.readFileSync('.github/workflows/pr-size-justification-template.md', 'utf8');
            const contributingLink = `https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md#code-quality-expectations`;
            const message = template.replace('CONTRIBUTING_LINK', contributingLink);

            // Request changes with explanation
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              event: 'REQUEST_CHANGES',
              body: message
            });

            console.log('Created review requesting changes for PR #' + prNumber);

      - name: Dismiss review if justification added
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        env:
          RESULT_JSON: ${{ steps.read.outputs.result }}
        with:
          script: |
            const result = JSON.parse(process.env.RESULT_JSON);

            if (!result.shouldDismiss) {
              console.log('No dismissal needed, skipping');
              return;
            }

            const prNumber = result.prNumber;

            // Find our previous review requesting changes
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const botReview = reviews.data.find(review =>
              review.user.login === 'github-actions[bot]' &&
              review.state === 'CHANGES_REQUESTED'
            );

            if (botReview) {
              await github.rest.pulls.dismissReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                review_id: botReview.id,
                message: 'Large PR justification has been provided. Thank you!'
              });

              console.log('Dismissed previous review:', botReview.id);

              // Add a comment confirming unblock
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: 'âœ… Large PR justification has been provided. The size review has been dismissed and this PR can now proceed with normal review.'
              });
            } else {
              console.log('No previous blocking review found to dismiss');
            }