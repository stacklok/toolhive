apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: st-embeddingserver-cache
spec:
  description: Deploys EmbeddingServer with model caching and verifies PVC is created
  timeouts:
    apply: 30s
    assert: 120s
    cleanup: 30s
    exec: 300s
  template: true
  bindings:
    - name: testPrefix
      value: "st-embedding-cache"
  steps:
  - name: verify-operator
    description: Ensure operator is ready before testing
    try:
    - assert:
        file: ../../../setup/assert-operator-ready.yaml
  - name: deploy-embeddingserver-with-cache
    description: Deploy EmbeddingServer with model caching enabled
    try:
    - apply:
        file: embeddingserver.yaml
    - assert:
        file: embeddingserver.yaml
    - assert:
        file: assert-embeddingserver-running.yaml
    - assert:
        file: assert-deployment-running.yaml
    - assert:
        file: assert-service-created.yaml

  - name: verify-model-cache-volume
    description: Verify that the PVC is mounted in the statefulset
    try:
    - script:
        env:
          - name: embeddingServerName
            value: ($testPrefix)
        content: |
          # Get the statefulset name
          echo "Verifying model cache for embedding server: $embeddingServerName"

          # Wait for PVC to provision
          echo "Waiting 60 seconds for PVC to provision..."
          sleep 60

          STATEFULSET_NAME="$embeddingServerName"
          # StatefulSet PVCs follow the pattern: volumeClaimTemplate-statefulsetName-ordinal
          PVC_NAME="model-cache-$embeddingServerName-0"

          # Check if PVC exists and is bound
          PVC_STATUS=$(kubectl get pvc $PVC_NAME -n toolhive-system -o jsonpath='{.status.phase}' 2>/dev/null || echo "NotFound")

          if [ "$PVC_STATUS" != "Bound" ]; then
            echo "PVC is not bound. Current status: $PVC_STATUS"
            echo "Available PVCs:"
            kubectl get pvc -n toolhive-system
            exit 1
          fi

          echo "✓ PVC is bound"

          # Check that the statefulset is ready
          kubectl wait --for=jsonpath='{.status.readyReplicas}'=1 --timeout=120s statefulset/$STATEFULSET_NAME -n toolhive-system

          echo "✓ StatefulSet is ready"

          # Verify that model files are written to the cache volume
          echo "Checking for model files in cache volume..."
          POD_NAME=$(kubectl get pods -n toolhive-system -l app.kubernetes.io/instance=$STATEFULSET_NAME --field-selector=status.phase=Running -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")

          if [ -z "$POD_NAME" ]; then
            echo "No running pod found for statefulset"
            exit 1
          fi

          echo "Checking cache contents in pod: $POD_NAME"

          # Wait for model to be downloaded (check logs for model loading)
          echo "Waiting for model to be downloaded..."
          MAX_WAIT=60
          COUNTER=0
          MODEL_LOADED=false

          while [ $COUNTER -lt $MAX_WAIT ]; do
            # Check if model files exist in /data
            CACHE_CONTENTS=$(kubectl exec -n toolhive-system $POD_NAME -- sh -c 'find /data -type f 2>/dev/null | wc -l' || echo "0")

            if [ "$CACHE_CONTENTS" -gt 0 ]; then
              MODEL_LOADED=true
              break
            fi

            echo "Waiting for model files to appear... ($COUNTER/$MAX_WAIT seconds)"
            sleep 2
            COUNTER=$((COUNTER + 2))
          done

          if [ "$MODEL_LOADED" = false ]; then
            echo "No model files found in /data after $MAX_WAIT seconds. Cache appears empty."
            echo "Listing /data contents:"
            kubectl exec -n toolhive-system $POD_NAME -- ls -laR /data || true
            echo "Pod logs:"
            kubectl logs -n toolhive-system $POD_NAME --tail=50 || true
            exit 1
          fi

          echo "✓ Model files found in cache volume"
          echo "Cache directory contents:"
          kubectl exec -n toolhive-system $POD_NAME -- sh -c 'du -sh /data/* 2>/dev/null' || true

          echo "✅ Model cache verification passed!"
          exit 0

  - name: test-embedding-endpoint
    description: Test the embedding server endpoint with cache
    try:
    - script:
        env:
          - name: embeddingServerName
            value: ($testPrefix)
        content: |
          # Get the service name for the embedding server
          echo "Testing embedding server with cache: $embeddingServerName"

          SERVICE_NAME="$embeddingServerName"
          CLUSTER_IP=$(kubectl get svc $SERVICE_NAME -n toolhive-system -o jsonpath='{.spec.clusterIP}' 2>/dev/null || echo "")

          if [ -z "$CLUSTER_IP" ]; then
            echo "Service not found or does not have ClusterIP"
            kubectl describe svc $SERVICE_NAME -n toolhive-system
            exit 1
          fi

          echo "Service ClusterIP: $CLUSTER_IP"

          # Test the health endpoint
          echo "Testing health endpoint..."
          kubectl run test-curl-$RANDOM --image=curlimages/curl:latest --rm -i --restart=Never -n toolhive-system -- \
            curl -s -o /dev/null -w "%{http_code}" http://$CLUSTER_IP:8080/health || true

          echo "✅ Embedding server with cache test passed!"
          exit 0
