{{- if or .Values.crds.install.server .Values.crds.install.virtualMcp }}
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    {{- if .Values.crds.keep }}
    helm.sh/resource-policy: keep
    {{- end }}
    controller-gen.kubebuilder.io/version: v0.17.3
  name: mcpexternalauthconfigs.toolhive.stacklok.dev
spec:
  group: toolhive.stacklok.dev
  names:
    kind: MCPExternalAuthConfig
    listKind: MCPExternalAuthConfigList
    plural: mcpexternalauthconfigs
    shortNames:
    - extauth
    - mcpextauth
    singular: mcpexternalauthconfig
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.type
      name: Type
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          MCPExternalAuthConfig is the Schema for the mcpexternalauthconfigs API.
          MCPExternalAuthConfig resources are namespace-scoped and can only be referenced by
          MCPServer resources within the same namespace. Cross-namespace references
          are not supported for security and isolation reasons.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: |-
              MCPExternalAuthConfigSpec defines the desired state of MCPExternalAuthConfig.
              MCPExternalAuthConfig resources are namespace-scoped and can only be referenced by
              MCPServer resources in the same namespace.
            properties:
              awsSts:
                description: |-
                  AWSSts configures AWS STS authentication with SigV4 request signing
                  Only used when Type is "awsSts"
                properties:
                  region:
                    description: Region is the AWS region for the STS endpoint and
                      service
                    minLength: 1
                    type: string
                  roleArn:
                    description: |-
                      RoleArn is the default IAM role ARN to assume
                      This role is used when no role mappings match or RoleMappings is empty
                    pattern: ^arn:aws:iam::\d{12}:role/[a-zA-Z0-9+=,.@\-_/]+$
                    type: string
                  roleClaim:
                    default: groups
                    description: |-
                      RoleClaim is the JWT claim to use for role mapping evaluation
                      Defaults to "groups" to match common OIDC group claims
                    type: string
                  roleMappings:
                    description: |-
                      RoleMappings defines claim-based role selection rules
                      Allows mapping JWT claims (e.g., groups, roles) to specific IAM roles
                      Higher priority mappings are evaluated first
                    items:
                      description: |-
                        RoleMapping defines a rule for mapping JWT claims to IAM roles.
                        Mappings are evaluated in priority order (highest first), and the first
                        matching rule determines which IAM role to assume.
                      properties:
                        claim:
                          description: |-
                            Claim is the claim value to match against
                            The claim type is specified by AWSStsConfig.RoleClaim
                            For example, if RoleClaim is "groups", this would be a group name
                          minLength: 1
                          type: string
                        priority:
                          default: 0
                          description: |-
                            Priority determines evaluation order (higher values evaluated first)
                            Allows fine-grained control over role selection precedence
                            Defaults to 0 if not specified
                          format: int32
                          minimum: 0
                          type: integer
                        roleArn:
                          description: RoleArn is the IAM role ARN to assume when
                            this mapping matches
                          pattern: ^arn:aws:iam::\d{12}:role/[a-zA-Z0-9+=,.@\-_/]+$
                          type: string
                      required:
                      - claim
                      - roleArn
                      type: object
                    type: array
                  service:
                    default: execute-api
                    description: |-
                      Service is the AWS service name for SigV4 signing
                      Defaults to "execute-api" for API Gateway endpoints
                    type: string
                  sessionDuration:
                    default: 3600
                    description: |-
                      SessionDuration is the duration in seconds for the STS session
                      Must be between 900 (15 minutes) and 43200 (12 hours)
                      Defaults to 3600 (1 hour) if not specified
                    format: int32
                    maximum: 43200
                    minimum: 900
                    type: integer
                  sessionTags:
                    description: |-
                      SessionTags are AWS session tags to pass to AssumeRole
                      Tags can use static values or be sourced from JWT claims
                    items:
                      description: |-
                        SessionTag represents an AWS session tag that can be passed to AssumeRole.
                        Tags can have static values or be dynamically sourced from JWT claims.
                      properties:
                        claimSource:
                          description: |-
                            ClaimSource is the JWT claim to use as the tag value
                            When specified, the tag value is sourced from this claim in the incoming JWT
                            Takes precedence over the static Value field
                          type: string
                        key:
                          description: |-
                            Key is the session tag key
                            Must comply with AWS session tag key requirements
                          maxLength: 128
                          minLength: 1
                          pattern: ^[\w+=,.@-]+$
                          type: string
                        value:
                          description: |-
                            Value is the static value for the session tag
                            Used when ClaimSource is not specified
                          maxLength: 256
                          type: string
                      required:
                      - key
                      type: object
                    type: array
                required:
                - region
                - roleArn
                type: object
              headerInjection:
                description: |-
                  HeaderInjection configures custom HTTP header injection
                  Only used when Type is "headerInjection"
                properties:
                  headerName:
                    description: HeaderName is the name of the HTTP header to inject
                    minLength: 1
                    type: string
                  valueSecretRef:
                    description: ValueSecretRef references a Kubernetes Secret containing
                      the header value
                    properties:
                      key:
                        description: Key is the key within the secret
                        type: string
                      name:
                        description: Name is the name of the secret
                        type: string
                    required:
                    - key
                    - name
                    type: object
                required:
                - headerName
                - valueSecretRef
                type: object
              tokenExchange:
                description: |-
                  TokenExchange configures RFC-8693 OAuth 2.0 Token Exchange
                  Only used when Type is "tokenExchange"
                properties:
                  audience:
                    description: Audience is the target audience for the exchanged
                      token
                    type: string
                  clientId:
                    description: |-
                      ClientID is the OAuth 2.0 client identifier
                      Optional for some token exchange flows (e.g., Google Cloud Workforce Identity)
                    type: string
                  clientSecretRef:
                    description: |-
                      ClientSecretRef is a reference to a secret containing the OAuth 2.0 client secret
                      Optional for some token exchange flows (e.g., Google Cloud Workforce Identity)
                    properties:
                      key:
                        description: Key is the key within the secret
                        type: string
                      name:
                        description: Name is the name of the secret
                        type: string
                    required:
                    - key
                    - name
                    type: object
                  externalTokenHeaderName:
                    description: |-
                      ExternalTokenHeaderName is the name of the custom header to use for the exchanged token.
                      If set, the exchanged token will be added to this custom header (e.g., "X-Upstream-Token").
                      If empty or not set, the exchanged token will replace the Authorization header (default behavior).
                    type: string
                  scopes:
                    description: Scopes is a list of OAuth 2.0 scopes to request for
                      the exchanged token
                    items:
                      type: string
                    type: array
                  subjectTokenType:
                    description: |-
                      SubjectTokenType is the type of the incoming subject token.
                      Accepts short forms: "access_token" (default), "id_token", "jwt"
                      Or full URNs: "urn:ietf:params:oauth:token-type:access_token",
                                    "urn:ietf:params:oauth:token-type:id_token",
                                    "urn:ietf:params:oauth:token-type:jwt"
                      For Google Workload Identity Federation with OIDC providers (like Okta), use "id_token"
                    pattern: ^(access_token|id_token|jwt|urn:ietf:params:oauth:token-type:(access_token|id_token|jwt))?$
                    type: string
                  tokenUrl:
                    description: TokenURL is the OAuth 2.0 token endpoint URL for
                      token exchange
                    type: string
                required:
                - audience
                - tokenUrl
                type: object
              type:
                description: Type is the type of external authentication to configure
                enum:
                - tokenExchange
                - headerInjection
                - unauthenticated
                - awsSts
                type: string
            required:
            - type
            type: object
          status:
            description: MCPExternalAuthConfigStatus defines the observed state of
              MCPExternalAuthConfig
            properties:
              configHash:
                description: ConfigHash is a hash of the current configuration for
                  change detection
                type: string
              observedGeneration:
                description: |-
                  ObservedGeneration is the most recent generation observed for this MCPExternalAuthConfig.
                  It corresponds to the MCPExternalAuthConfig's generation, which is updated on mutation by the API Server.
                format: int64
                type: integer
              referencingServers:
                description: |-
                  ReferencingServers is a list of MCPServer resources that reference this MCPExternalAuthConfig
                  This helps track which servers need to be reconciled when this config changes
                items:
                  type: string
                type: array
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
{{- end }}
